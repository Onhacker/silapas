<IfModule mod_php8.c>
  AddHandler application/x-httpd-php80 .php
</IfModule>

# ===== CodeIgniter rewrite =====
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php/$1 [L]

# ================= CACHING & COMPRESSION =================

# --- Expires untuk aset statik saja ---
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 0 seconds"        # default aman (jangan lama)

  # Gambar & font → lama (1 tahun), karena biasanya versi via filename/query
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"

  # CSS/JS → 1 bulan (atau 1 tahun kalau sudah pakai fingerprint)
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
</IfModule>

<IfModule mod_headers.c>
  # 1) GLOBAL DEFAULT: jangan set Cache-Control global (berbahaya untuk HTML)
  #    Kita batasi per tipe file atau pakai env flag saja.

  # 2) Cache lama untuk aset statik (ekstensi yang aman)
  <FilesMatch "\.(?:css|js|mjs|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|otf|map)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # 3) HTML & PHP → no-cache
  <FilesMatch "\.(?:html|php)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>

  # 4) Service Worker jangan pernah di-cache
  <FilesMatch "^service_worker\.js$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    # (opsional) perluas scope SW:
    # Header always set Service-Worker-Allowed "/"
  </FilesMatch>

  # 5) Force no-cache untuk route sensitif via env flag
  #    (login, admin, api). .htaccess tidak punya <Location>, jadi pakai E flag.
</IfModule>

# Set env flag untuk route sensitif
RewriteRule ^(login|admin|api)(/.*)?$ - [E=FORCE_NOCACHE:1]

<IfModule mod_headers.c>
  Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0" env=FORCE_NOCACHE
  Header set Pragma "no-cache" env=FORCE_NOCACHE
  Header set Expires "0" env=FORCE_NOCACHE
</IfModule>

# --- Gzip/Brotli compression ---
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  # (hapus baris duplikat/typo yang lama)
</IfModule>
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/css
  AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json application/xml
</IfModule>

# (opsional) proteksi file sensitif
<FilesMatch "^(\.env|composer\.(json|lock)|package\.json|yarn\.lock|phpunit\.xml)$">
  Require all denied
</FilesMatch>
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>
FileETag None
